---

- name: Configure Jenkins
  block:
    - name: 10 - Include project properties
      include_vars:
        file: "{{ playbook_dir }}/workspace/vars.yml"

    - name: 20 - Download Jenkins agent.jar from master
      ansible.builtin.get_url:
        url: "http://{{ jenkins_master_ip }}:8080/jnlpJars/agent.jar"
        dest: "/home/{{ ansible_user }}/agent.jar"
        mode: '0755'
    
    - name: 30 - Create jenkins-agent.service
      ansible.builtin.template:
        src: jenkins-agent.service.j2
        dest: /etc/systemd/system/jenkins-agent.service
        mode: '0644'
      become: true
      
    - name: 40 - Reload systemd configuration
      systemd:
        daemon_reload: yes
      become: true
    
    - name: 50 - Enable and start jenkins-agent service
      ansible.builtin.service:
        name: jenkins-agent
        state: started
        enabled: true
      become: true
